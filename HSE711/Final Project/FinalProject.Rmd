---
title: "FinalProject"
author: "Meha Goyal"
date: "2025-10-01"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
data <- read.csv('/Users/mehagoyal/Desktop/Dartmouth Projects/Final Project/counts.csv', check.names = FALSE)
```

```{r}
meta_data <- read.csv('/Users/mehagoyal/Desktop/Dartmouth Projects/Final Project/meta_data.csv', check.names = FALSE)
```

```{r}
colnames(meta_data)
```


```{r}
# head(data)
head(meta_data)
```


```{r}
num_samples <- ncol(data)
num_samples

num_genes <- nrow(data)
num_genes
```

```{r}
gene1 <- data[1, -1]
gene2 <- data[2, -1]

gene1_name <- data[1, 1]  
gene2_name <- data[2,1]

gene1_df <- data.frame(
  sample = colnames(data)[-1],
  data = as.numeric(gene1)
)

gene2_df <- data.frame(
  sample = colnames(data)[-1],
  data = as.numeric(gene2)
)

gene1_name

gene2_name
```

```{r}
summary_stats <- data.frame(
  gene = gene1_name,
  mean = mean(gene1_df$data),
  median = median(gene1_df$data),
  sd = sd(gene1_df$data),
  min = min(gene1_df$data),
  max = max(gene1_df$data)
)

summary_stats
```

```{r}
library(ggplot2)

ggplot(gene1_df, aes(x = data)) +
  geom_histogram(bins = 50, fill = "lightblue", color = "black") +
  labs(
    title = paste("Histogram of", gene1_name, "across samples"),
    x = "Counts", y = "Frequency"
  )
```

```{r}
scatter_df <- data.frame(
  gene1 = gene1_df$data,
  gene2 = gene2_df$data,
  sample = gene1_df$sample
)

ggplot(scatter_df, aes(x = gene1, y = gene2)) +
  geom_point(alpha = 0.7) +
  labs(
    title = paste("Scatter Plot:", gene1_name, "vs", gene2_name),
    x = gene1_name, y = gene2_name
  )
```

```{r}
colnames(data)[1:10]

```

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)

if (colnames(data)[1] == "") {
  colnames(data)[1] <- "gene_id"
}

gene_col <- colnames(data)[1]

gene1_name <- data[[gene_col]][1]

data_long <- data %>%
  pivot_longer(
    cols = setdiff(colnames(data), gene_col),  # everything except gene_id
    names_to = "sample",
    values_to = "count"
  )

gene1_df <- data_long %>%
  filter(.data[[gene_col]] == gene1_name)

violin_df <- gene1_df %>%
  left_join(meta_data, by = c("sample" = "barcode")) %>%
  filter(!is.na(primary_diagnosis))

ggplot(violin_df, aes(x = primary_diagnosis, y = count, fill = primary_diagnosis)) +
  geom_violin(trim = FALSE, alpha = 0.7) +
  geom_boxplot(width = 0.1, outlier.shape = NA, alpha = 0.4, color = "black") +
  labs(
    title = paste("Distribution of", gene1_name, "Counts by Primary Diagnosis"),
    x = "Primary Diagnosis",
    y = "Expression Count"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  )

```



```{r heatmap, echo=FALSE, fig.width=10, fig.height=8}
library(ComplexHeatmap)
library(circlize)
library(dplyr)

gene_col <- colnames(data)[1]
selected_genes <- data[[gene_col]][1:10]

subset_data <- data %>%
  filter(.data[[gene_col]] %in% selected_genes)

count_matrix <- as.matrix(subset_data[, -1])
rownames(count_matrix) <- subset_data[[gene_col]]

count_matrix <- log2(count_matrix + 1)

meta_matched <- meta_data[match(colnames(count_matrix), meta_data$barcode), ]

diagnosis_vec <- meta_matched$primary_diagnosis
diagnosis_vec[is.na(diagnosis_vec)] <- "Unknown"

diagnosis_levels <- unique(diagnosis_vec)
diagnosis_colors <- setNames(
  circlize::rand_color(length(diagnosis_levels)),
  diagnosis_levels
)

# used ai for some syntax to fix my annotation, because it was throwing an error about column formatting

annotation <- HeatmapAnnotation(
  Diagnosis = diagnosis_vec,
  col = list(Diagnosis = diagnosis_colors)
)

Heatmap(
  count_matrix,
  name = "log2(Count + 1)",
  top_annotation = annotation,
  show_row_names = TRUE,
  show_column_names = FALSE,
  cluster_rows = TRUE,
  cluster_columns = TRUE,
  column_title = "Samples",
  row_title = "Genes",
  heatmap_legend_param = list(title = "Expression Level")
)

```


```{r}
covariate1 <- "primary_diagnosis"
covariate2 <- "age_at_diagnosis"

table1 <- table(meta_data[[covariate1]], useNA = "ifany")
table2 <- data.frame(
  Covariate = c(covariate2),
  Mean = mean(meta_data[[covariate2]], na.rm = TRUE),
  Median = median(meta_data[[covariate2]], na.rm = TRUE),
  SD = sd(meta_data[[covariate2]], na.rm = TRUE),
  Min = min(meta_data[[covariate2]], na.rm = TRUE),
  Max = max(meta_data[[covariate2]], na.rm = TRUE)
)

# got code for formatting table cleanly from openai
knitr::kable(as.data.frame(table(meta_data$primary_diagnosis)),
             caption = "Primary Diagnosis Counts")

```
```{r}
table2
```

```{r gene_correlation_matrix, message=FALSE, warning=FALSE}

library(corrplot)

colnames(data)[1] <- "Gene"

expr_only <- subset_data[, -1]
expr_only <- as.data.frame(lapply(expr_only, function(x) as.numeric(as.character(x))))

gene_expr <- t(expr_only)
colnames(gene_expr) <- data$Gene[data$Gene %in% selected_genes]

cor_matrix <- cor(gene_expr, use = "pairwise.complete.obs", method = "pearson")

# Visualize correlation matrix
corrplot(cor_matrix,
         method = "color",
         tl.col = "black",
         tl.srt = 45,
         addCoef.col = "black",
         number.cex = 0.7,
         col = colorRampPalette(c("blue", "white", "red"))(200),
         title = "Correlation Matrix of Selected Breast Cancer Genes",
         mar = c(0,0,2,0))

```

